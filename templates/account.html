{% extends 'base.html' %}
{% load static %}

{% block title %}Mon Compte - TicketsPlease{% endblock %}

{% block content %}
<script>
    // Détection de popup et auto-fermeture
    (function() {
        console.log('Vérification si cette page est dans une popup');
        
        // Détecter si nous sommes dans une popup
        var isInPopup = false;
        
        // Méthode 1: vérifier la taille de la fenêtre (les popups sont généralement plus petites)
        if (window.innerWidth < 800 && window.innerHeight < 800) {
            isInPopup = true;
            console.log('Détecté comme popup par la taille de fenêtre');
        }
        
        // Méthode 2: vérifier si c'est une fenêtre indépendante sans barre d'onglets
        try {
            isInPopup = isInPopup || (window.opener && window.opener !== window);
            if (window.opener) {
                console.log('Détecté comme popup car window.opener existe');
            }
        } catch(e) {
            console.error('Erreur lors de la vérification de window.opener:', e);
        }
        
        // Si nous sommes dans une popup, fermer et rediriger la page principale
        if (isInPopup) {
            console.log('Cette page est dans une popup, tentative de redirection et fermeture');
            try {
                // Rediriger la page principale si possible
                if (window.opener) {
                    console.log('Redirection de la page principale vers /account/');
                    window.opener.location.href = '/account/';
                }
                
                // Fermer cette fenêtre
                console.log('Fermeture de la popup');
                setTimeout(function() {
                    window.close();
                }, 100);
            } catch(e) {
                console.error('Erreur lors de la fermeture/redirection:', e);
            }
        }
    })();
</script>

<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-[var(--ocean)] mb-6">Mon Compte</h1>
            
            {% if user.is_authenticated %}
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Informations personnelles -->
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-user-circle text-[var(--sunset)] mr-2"></i> Informations personnelles
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <p class="text-gray-500 text-sm">Nom d'utilisateur</p>
                                <p class="font-medium">{{ user.username|default:"Non défini" }}</p>
                            </div>
                            
                            <div>
                                <p class="text-gray-500 text-sm">Email</p>
                                <p class="font-medium">{{ user.email }}</p>
                            </div>
                            
                            <div>
                                <p class="text-gray-500 text-sm">Date d'inscription</p>
                                <p class="font-medium">{{ user.date_joined|date:"d/m/Y" }}</p>
                            </div>
                            
                            <button class="mt-2 bg-[var(--ocean)] text-white rounded-lg py-2 px-4 hover:bg-[var(--ocean-light)] transition-colors">
                                <i class="fas fa-pencil-alt mr-1"></i> Modifier
                            </button>
                        </div>
                    </div>
                    
                    <!-- Paramètres du compte -->
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-cog text-[var(--sunset)] mr-2"></i> Paramètres du compte
                        </h2>
                        
                        <div class="space-y-4">
                            <a href="{% url 'account_email' %}" class="block py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">Adresses email</p>
                                        <p class="text-sm text-gray-500">Gérer vos adresses email associées</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </a>
                            
                            <a href="{% url 'account_change_password' %}" class="block py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">Mot de passe</p>
                                        <p class="text-sm text-gray-500">Modifier votre mot de passe</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </a>
                            
                            <a href="{% url 'socialaccount_connections' %}" class="block py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">Comptes sociaux</p>
                                        <p class="text-sm text-gray-500">Gérer les connexions Google, Facebook, etc.</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Statistiques et activité -->
                    <div class="md:col-span-2 bg-white rounded-xl border border-gray-200 p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line text-[var(--sunset)] mr-2"></i> Votre activité
                        </h2>
                        
                        <div class="bg-gray-50 rounded-lg p-6 text-center">
                            <p class="text-gray-500 mb-2">Vous n'avez pas encore de tickets. Explorez nos offres pour planifier votre prochain voyage.</p>
                            <a href="#" class="inline-block bg-[var(--sunset)] text-white font-medium rounded-lg py-2 px-6 hover:bg-[#FFA947] transition-colors">
                                <i class="fas fa-search mr-1"></i> Découvrir les tickets
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <div class="text-5xl text-[var(--ocean)] mb-4">
                        <i class="fas fa-user-lock"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Vous n'êtes pas connecté</h2>
                    <p class="text-gray-500 mb-6">Connectez-vous pour accéder à votre compte</p>
                    <div class="flex justify-center space-x-4">
                        <a href="{% url 'sign_in' %}" class="bg-[var(--ocean)] text-white py-2 px-6 rounded-lg hover:bg-[var(--ocean-light)] transition-colors">
                            Se connecter
                        </a>
                        <a href="{% url 'account_signup' %}" class="border border-[var(--ocean)] text-[var(--ocean)] py-2 px-6 rounded-lg hover:bg-gray-50 transition-colors">
                            Créer un compte
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
